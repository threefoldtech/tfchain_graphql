version: "3.4"

services:
  # db:
  #   image: cockroachdb/cockroach:v22.2.2
  #   restart: always
  #   ports:
  #     - "26257:26257"
  #     - "8080:8080"
  #   command: start-single-node --insecure
  #   volumes:
  #     - /var/lib/cockroach/data

  ingest:
    # depends_on:
    # - db
    restart: on-failure
    image: subsquid/substrate-ingest:1
    volumes:
      - "./typesBundle.json:/configs/typesBundle.json"
    command:
      [
        "-e",
        "${WS_ENDPOINT}",
        # "-e",
      # "${WS_ENDPOINT2}",
        "-c",
        "20",
        "--out",
        "postgres://root@172.17.0.1:26257/defaultdb",
        "--types-bundle",
        "/configs/typesBundle.json"
      ]

  gateway:
    # depends_on:
    # - db
    image: subsquid/substrate-gateway:2.5.0
    environment:
      DATABASE_MAX_CONNECTIONS: 5
      RUST_LOG: "actix_web=info,actix_server=info"
    command:
      [
        "--database-url",
        "postgres://root@172.17.0.1:26257/defaultdb",
        "--database-max-connections",
        "3"
      ]
    ports:
      - "8888:8000"
  # explorer:
  #   image: subsquid/substrate-explorer:firesquid
  #   environment:
  #     DB_TYPE: postgres
  #     DB_HOST: db
  #     DB_PORT: "5432"
  #     DB_NAME: "squid-archive"
  #     DB_USER: "postgres"
  #     DB_PASS: "postgres"
  #   ports:
  #     - "4444:3000"
